<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.accounting.mapper.FinancialReportMapper">
    
    <!-- 资产负债表：根据已过账凭证计算科目余额 -->
    <select id="getBalanceSheet" resultType="map">
        SELECT 
            s.type,
            s.name,
            COALESCE(SUM(
                CASE 
                    WHEN s.balance_direction = 1 THEN COALESCE(d.debit_amount, 0) - COALESCE(d.credit_amount, 0)
                    ELSE COALESCE(d.credit_amount, 0) - COALESCE(d.debit_amount, 0)
                END
            ), 0) as amount
        FROM accounting_subject s
        LEFT JOIN journal_entry_detail d ON s.id = d.subject_id
        LEFT JOIN journal_entry e ON d.entry_id = e.id 
            AND e.status = 1 
            AND DATE_FORMAT(e.voucher_date, '%Y-%m') &lt;= #{date}
        WHERE s.status = 1 
            AND s.type IN (1, 2, 4)
        GROUP BY s.id, s.type, s.name, s.code
        HAVING amount != 0
        ORDER BY s.type, s.code
    </select>
    
    <!-- 利润表：根据已过账凭证计算收入费用类科目发生额 -->
    <select id="getProfitStatement" resultType="map">
        SELECT 
            CASE 
                WHEN s.code LIKE '6001%' OR s.code LIKE '6051%' OR s.code LIKE '6101%' OR s.code LIKE '6111%' THEN 'revenue'
                WHEN s.code LIKE '6401%' OR s.code LIKE '6402%' OR s.code LIKE '6403%' 
                     OR s.code LIKE '6601%' OR s.code LIKE '6602%' OR s.code LIKE '6603%' 
                     OR s.code LIKE '6701%' OR s.code LIKE '6711%' THEN 'cost'
                ELSE 'other'
            END as type,
            s.name,
            COALESCE(SUM(
                CASE 
                    -- 收入类科目：贷方-借方
                    WHEN s.code LIKE '6001%' OR s.code LIKE '6051%' OR s.code LIKE '6101%' OR s.code LIKE '6111%' 
                    THEN COALESCE(d.credit_amount, 0) - COALESCE(d.debit_amount, 0)
                    -- 成本费用类科目：借方-贷方
                    WHEN s.code LIKE '6401%' OR s.code LIKE '6402%' OR s.code LIKE '6403%' 
                         OR s.code LIKE '6601%' OR s.code LIKE '6602%' OR s.code LIKE '6603%' 
                         OR s.code LIKE '6701%' OR s.code LIKE '6711%'
                    THEN COALESCE(d.debit_amount, 0) - COALESCE(d.credit_amount, 0)
                    ELSE 0
                END
            ), 0) as amount
        FROM accounting_subject s
        INNER JOIN journal_entry_detail d ON s.id = d.subject_id
        INNER JOIN journal_entry e ON d.entry_id = e.id 
            AND e.status = 1
            AND DATE(e.voucher_date) BETWEEN #{startDate} AND #{endDate}
        WHERE s.status = 1 
            AND s.type = 6
            AND (s.code LIKE '6001%' OR s.code LIKE '6051%' OR s.code LIKE '6101%' OR s.code LIKE '6111%'
                 OR s.code LIKE '6401%' OR s.code LIKE '6402%' OR s.code LIKE '6403%' 
                 OR s.code LIKE '6601%' OR s.code LIKE '6602%' OR s.code LIKE '6603%' 
                 OR s.code LIKE '6701%' OR s.code LIKE '6711%')
        GROUP BY s.id, s.type, s.name, s.code
        HAVING amount != 0
        ORDER BY s.code
    </select>
    
    <!-- 现金流量表：根据已过账凭证计算现金类科目发生额 -->
    <!-- 根据凭证的业务类型和科目编码判断现金流类型 -->
    <select id="getCashFlowStatement" resultType="map">
        SELECT 
            CASE 
                -- 根据业务类型判断：采购、销售、员工费用、工资发放为经营活动
                WHEN e.business_type IN ('PURCHASE', 'SALES', 'EXPENSE', 'SALARY') THEN 'operating'
                -- 根据科目编码判断：投资相关科目为投资活动
                WHEN s.code LIKE '15%' OR s.code LIKE '16%' OR s.code LIKE '17%' THEN 'investing'
                -- 根据科目编码判断：借款、实收资本等为筹资活动
                WHEN s.code LIKE '20%' OR s.code LIKE '22%' OR s.code LIKE '40%' THEN 'financing'
                -- 默认归为经营活动
                ELSE 'operating'
            END as type,
            s.name,
            COALESCE(SUM(COALESCE(d.debit_amount, 0) - COALESCE(d.credit_amount, 0)), 0) as amount
        FROM accounting_subject s
        INNER JOIN journal_entry_detail d ON s.id = d.subject_id
        INNER JOIN journal_entry e ON d.entry_id = e.id 
            AND e.status = 1
            AND DATE(e.voucher_date) BETWEEN #{startDate} AND #{endDate}
        WHERE s.status = 1 
            AND (s.code LIKE '1001%' OR s.code LIKE '1002%')
        GROUP BY s.id, s.type, s.name, s.code, e.business_type
        HAVING amount != 0
        ORDER BY s.code
    </select>
</mapper>